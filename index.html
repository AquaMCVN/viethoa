<!DOCTYPE html>
<html>
<head>
    <title>YAML Config Translator</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <style>
        body {
            padding: 20px;
        }
        #resultText {
            min-height: 200px;
        }
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 60px;
        }
        .loading-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-popup .content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #007bff;
            border-radius: 10px;
            transition: width 0.3s ease-in-out;
        }
        .download-button {
            margin-top: 10px;
        }
        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>YAML Config Translator</h1>
        <div class="form-group">
            <label for="configInput">Paste YAML Config:</label>
            <textarea class="form-control" id="configInput" rows="5"></textarea>
        </div>
        <div class="custom-file mb-3">
            <input type="file" class="custom-file-input" id="configFile">
            <label class="custom-file-label" for="configFile">Choose file or drag & drop</label>
        </div>
        <button id="translateButton" class="btn btn-primary mb-3">Translate</button>
        
        <div class="loading-popup" id="loadingPopup" style="display: none;">
            <div class="content">
                <h4>Translating...</h4>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div id="progressText">0%</div>
            </div>
        </div>

        <textarea id="resultText" class="form-control" style="display: none;"></textarea>
        <a href="#" class="btn btn-success download-button" id="downloadButton" style="display: none;">Download Translated File</a>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        // Cache for translations to avoid redundant API calls
        const translationCache = new Map();
        
        // Queue for managing concurrent translations
        class TranslationQueue {
            constructor(maxConcurrent = 5) {
                this.queue = [];
                this.running = 0;
                this.maxConcurrent = maxConcurrent;
            }

            async add(task) {
                this.queue.push(task);
                this.processQueue();
            }

            async processQueue() {
                if (this.running >= this.maxConcurrent || this.queue.length === 0) return;
                
                this.running++;
                const task = this.queue.shift();
                try {
                    await task();
                } finally {
                    this.running--;
                    this.processQueue();
                }
            }
        }

        const queue = new TranslationQueue();

        // Parse YAML and extract translatable strings
        function parseYAML(text) {
            try {
                const doc = jsyaml.load(text);
                const strings = new Map();
                
                function traverse(obj, path = '') {
                    if (!obj) return;
                    
                    if (typeof obj === 'string') {
                        // Skip technical strings and special patterns
                        if (!shouldTranslate(obj)) return;
                        strings.set(path, obj);
                        return;
                    }
                    
                    if (Array.isArray(obj)) {
                        obj.forEach((item, index) => traverse(item, `${path}[${index}]`));
                        return;
                    }
                    
                    if (typeof obj === 'object') {
                        Object.entries(obj).forEach(([key, value]) => {
                            const newPath = path ? `${path}.${key}` : key;
                            traverse(value, newPath);
                        });
                    }
                }
                
                traverse(doc);
                return { doc, strings };
            } catch (error) {
                console.error('YAML parsing error:', error);
                return null;
            }
        }

        function shouldTranslate(text) {
            // Skip if text is empty or contains only special characters
            if (!text.trim() || text.length < 2) return false;
            
            // Skip technical patterns
            const skipPatterns = [
                /^[0-9]+$/,                     // Numbers only
                /^(true|false)$/i,              // Booleans
                /^(enabled|disabled)$/i,        // Common settings
                /^[A-Z0-9_]+$/,                // Constants
                /^https?:\/\//,                // URLs
                /^[#@$&*]+$/,                  // Special characters only
                /^\{.*\}$/,                    // Variable placeholders
                /^<%.*%>$/,                    // Template tags
                /^[a-zA-Z0-9_-]+\.[a-z]+$/    // File names
            ];
            
            return !skipPatterns.some(pattern => pattern.test(text));
        }

        async function translateText(text, sourceLang = 'en', targetLang = 'vi') {
            if (translationCache.has(text)) {
                return translationCache.get(text);
            }

            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                const translation = data[0][0][0];
                translationCache.set(text, translation);
                return translation;
            } catch (error) {
                console.error('Translation error:', error);
                return text;
            }
        }

        async function processTranslation(yamlText) {
            const parsed = parseYAML(yamlText);
            if (!parsed) return null;
            
            const { doc, strings } = parsed;
            const total = strings.size;
            let completed = 0;
            
            const updateProgress = () => {
                completed++;
                const percentage = Math.round((completed / total) * 100);
                $('#progressBar').css('width', `${percentage}%`);
                $('#progressText').text(`${percentage}%`);
            };

            // Process translations in parallel with rate limiting
            const translations = new Map();
            const promises = [];

            for (const [path, text] of strings) {
                const promise = queue.add(async () => {
                    const translated = await translateText(text);
                    translations.set(path, translated);
                    updateProgress();
                });
                promises.push(promise);
            }

            await Promise.all(promises);

            // Apply translations back to the document
            function applyTranslations(obj, path = '') {
                if (!obj) return obj;

                if (typeof obj === 'string') {
                    const translatedText = translations.get(path);
                    return translatedText || obj;
                }

                if (Array.isArray(obj)) {
                    return obj.map((item, index) => 
                        applyTranslations(item, `${path}[${index}]`)
                    );
                }

                if (typeof obj === 'object') {
                    const result = {};
                    Object.entries(obj).forEach(([key, value]) => {
                        const newPath = path ? `${path}.${key}` : key;
                        result[key] = applyTranslations(value, newPath);
                    });
                    return result;
                }

                return obj;
            }

            const translatedDoc = applyTranslations(doc);
            return jsyaml.dump(translatedDoc, {
                indent: 2,
                lineWidth: -1,
                forceQuotes: true
            });
        }

        // Event Handlers
        $('#translateButton').click(async function() {
            const configText = $('#configInput').val();
            const file = $('#configFile')[0].files[0];
            
            if (!configText && !file) {
                alert('Please provide YAML content or select a file.');
                return;
            }

            $('#loadingPopup').show();
            $('#progressBar').css('width', '0%');
            $('#progressText').text('0%');

            try {
                let yamlText = configText;
                if (file) {
                    yamlText = await file.text();
                }

                const translatedText = await processTranslation(yamlText);
                if (translatedText) {
                    $('#resultText').val(translatedText).show();
                    $('#downloadButton')
                        .attr('href', 'data:text/yaml;charset=utf-8,' + encodeURIComponent(translatedText))
                        .attr('download', file ? file.name.replace(/\.[^/.]+$/, '_translated.yml') : 'translated_config.yml')
                        .show();
                } else {
                    alert('Error processing YAML. Please check the format.');
                }
            } catch (error) {
                console.error('Translation error:', error);
                alert('An error occurred during translation.');
            } finally {
                $('#loadingPopup').hide();
            }
        });

        $('#configFile').change(function() {
            const fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').html(fileName || 'Choose file or drag & drop');
        });
    </script>

    <footer>
        <div class="footer">
            <p class="text-center">Enhanced YAML Translator</p>
        </div>
    </footer>
</body>
</html>
